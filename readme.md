# 三四五：电影院选座

清华大学软件学院2025夏《Web前端技术实训》课程

三四五组大作业：电影院选座

<img src="pic/345logo.PNG" style="zoom: 25%;" />

## 一、项目介绍

### 1.1 预览

（TODO：此处放一个视频）

### 1.2 项目背景

* 项目目标：使用 Canvas 技术设计并实现一个可交互的电影院选座软件
* 核心需求：支持个人与团体票的自动和手动选座，并根据不同年龄段（少年、成年、老年）的观众遵循特定的选座规则

### 1.3 实现功能预览

* 基础功能
  * 影厅绘制：基于 Canvas 绘制弧形排列的电影院座位图，包含明确的排号和座位号
  * 座位状态：不同颜色直观展示座位状态
  * 选座模式：支持单选、多选，以及根据规则的智能自动选座
  * 票务管理：实现了预订、付款购票、取消预定、退票退款等一系列票务操作流程

*  扩展功能
  * 不同大小的放映厅：通过静态配置参数实现96人、200人、300人的放映厅
  * 动态配置：支持通过页面上的交互组件自定义不同大小的影厅
* 其他优点
  * 动态效果
  * 视觉美感
  * 内涵彩蛋，敬请期待~

## 二、使用说明

### **2.1 运行环境**

* 推荐浏览器：Google Chrome 浏览器的最新稳定版
* 打开方式：直接在浏览器中打开 `index.html` 即可

### 2.2 界面布局介绍

（五粮液TODO：介绍各个界面的布局和功能，可以和2.3合并，多放一些图片，可以在截图上增加一些框和箭头用于说明，好看一点的框和箭头）

### **2.3 操作指南**

（五粮液TODO）

## 三、实现思路及技术应用

### 3.1 系统流程设计

（停云TODO：）

### 3.2 数据结构设计

（停云TODO：seat、ticket）

### 3.3 核心算法设计

（停云TODO：自动选座、选座验证、订单操作）

### 3.4 数据存储机制

影院涉及关键数据分为以下几个部分，根据调用需求不同以不同方式存储：

- **当前选择电影信息**：每一个电影和一个影厅大小可以确定一个特定影厅
  - **存储方式**：以对应的Key存在`localStorage`中。
  - **Key**：`selectedMovieInfo`
  - **存储内容**：行列信息`cols`、`rows`，电影信息`id`、`title`，电影贴图路径`image`，票价`price`，开始时间`time`

- **影院座位状态数据**：根据每一个电影和一个影厅大小可以确定的特定影厅，储存其座位状态。
  - **存储方式**：以对应的Key存在`localStorage`中。
  - **Key**：`cinemaState-{电影名}-{rows}x{cols}`。
  - **存储内容**：二维数组`cinemaSeats`，每个元素包含对应作为的`row`，` col`， `id`，`status`信息。
- 选座界面输入数据：选座界面接受的输入有客户输入的信息以及客户选择的具体座位。
  - **存储方式**：客户信息直接存储在 DOM 元素中，而选中座位则直接更改`main.js`中的座位状态并实时查询。
  - **存储内容**：票务类型，用户姓名及年龄。
- **订单信息**：订单信息包含座位信息、客户信息以及电影信息。
  - **存储方式**：以对应的Key存在`localStorage`中。
  - **Key**：`movieTicketOrders`
  - **存储内容**：为一个订单列表，每个订单包含信息有：购票Id`ticketId`，订单状态`status`，座位`seats`，客户信息`customerInfo`，电影信息`movieInfo`，单价`unitPrice`，总价`totalCost`，创建时间`createdAt`，过期时间`expiresAt`（预订票），支付时间`paidAt`（直购票或支付后的预定票）。


#### 当前选择电影信息

需要由前两个页面决定，因此先在第一个页面暂存行列信息后，进入第二个页面后得到所选电影，由此得到电影id、电影名、开始时间等信息，在初始化影院选座界面的实际存入`localStorage`，后续过程中对该信息只读不写，直到整个订单流程结束后，在返回配置界面时清除电影信息在`localStorage`中的存储，等待新订单重复前面的流程。

#### 影院座位状态数据

整个订单流程中，影院座位状态数据经历了三个阶段。

- **初始化阶段**：由前面两个界面选择结束后，可确定影院座位状态数据的Key，根据Key在`localStorage`中查找是否有了对应的座位状态信息，如果已经有就加载进当前的`cinemaSeats`，若没有，则初始化对应大小的影厅并存入`localStorage`等待后续调用。
- **选座阶段**：这一阶段仅会涉及到`available`和`selected`之间的切换，在订单确认之前无需存入`localStorage`，只需完成交互即可。
- **订单阶段**：订单完成后需要根据订单具体情况更改`cinemaSeats`的相应座位状态并存入`localStorage`，预定完成和支付完成两个动作只需要更改当前的信息即可，但是涉及到检查预定是否过期、退款、取消预定、支付预定、退款这几个操作则可能去更改当前`cinemaSeats`所存储座位状态以外的数据。因此需要根据订单存储的电影信息来查找对应Key并该Key下存储的影院座位状态数据。

#### 选座界面输入数据

客户信息只需要调用`getGroupMembersList()`和`getIndividualMembersList()`查询DOM来获取即可，而座位信息在处理订单相关的函数中只需要遍历`cinemaSeats`查看座位是否为`selected`状态即可。

#### 订单信息

在每一个与订单相关的操作完成后都同步到`localStorage`中，在系统启动时自动从`localStorage`中加载订单。

### 3.5 Canvas绘制

`canvas.js` 文件负责将影院座位数据以可视化方式呈现在页面上，核心机制如下：

#### 数据来源

- **座位数据**：从`main.js`获取，得到二维数组，每个元素为座位对象（包含 row、col、id、status 等）。
- **当前影厅配置**：从`main.js`获取，包括总排数、总列数等。
- **选中状态**：从`stateManager.js`获取获取当前被选中的座位列表，辅助高亮显示。

#### 绘制流程

`canvas.js`维护一个 GLOBAL_STATE 对象，记录当前画布、布局类型、行列数、中心区域信息等，确保绘制时状态一致。

- **初始化与绘制**：首先完成 Canvas 初始化、座位数据加载、图片预加载，并调用 drawCinema() 完成实际绘制。

- **核心绘制函数**：

  `drawCinema()`负责整体绘制流程，包括：

  - 清空画布
  - 绘制中央过道虚线
  - 计算并绘制中心区域
  - 遍历所有座位，调用 `drawSeat(x, y, seat)`绘制每个座位
  - 绘制中心区域标识（矩形或扇形，取决于布局）

- **座位绘制**
  `drawSeat(x, y, seat)`根据座位状态（available、selected、sold、reserved）选择不同图片或颜色，并在座位中心绘制排号和座号。若座位被选中或悬停，会有缩放高亮效果。
  
- **布局支持**
  支持弧形（ARC）和矩形（PARALLEL）两种布局，通过 `GLOBAL_STATE.currentLayout` 切换，分别采用不同的坐标计算方式。

#### 交互与刷新

- **布局切换**
  通过 `toggleLayout()` 切换布局类型，并自动重绘。
- **数据变更刷新**
  调用 `refreshCinemaDisplay()` 可在座位数据变化后重新绘制，确保画面与数据同步。

- 页面加载时自动初始化并绘制影院布局。
- 提供全局导出接口 `window.CanvasRenderer`，供其他模块调用绘制、刷新、布局切换等功能。

### 3.6 页面逻辑

（五粮液TODO）

### 3.7 交互设计

（sigamalTODO）

## 四、遇到问题及解决办法

问题一：（简称）（停云TODO：写3个）

* 问题描述：
* 原因分析：
* 解决方法：

问题四：中心区域对齐问题

* 问题描述：座位的中心区域的绘制有错位的问题
* 原因分析：因为需要根据座位总列数为基数还是偶数来微调座位整体角度以保证居中，而中心区域起初是画出的扇形区域的正中间部分，因此无法适应座位变化。
* 解决方法：计算出中心座位的相应编号，在座位图中画出四个点，首先连接两条纵向边，再根据半径

问题五：座位状态信息存储优化

- 问题描述：座位状态存储有问题。
- 原因分析：在一开始设计的座位信息只在`main.js`中的`cinemaSeat`之中存储，完全没有考虑到不同电影以及不同大小影厅都需要对应一个独立的影院的问题，因此需要对每一个特定大小以及对应电影的影厅进行单独存储，加入了根据Key在`localStorage`中存取的机制。加入这个机制之后又因为之前的实现的初始化比较随意，各个页面切换都有重新初始化，存在覆盖的问题，所以座位状态的更新仍存在较大问题。
- 解决方法：检查所有影院初始化函数，仅保留一个初始化函数`initializeCinemaSeats`，且仅在进入选座界面的那个契机进行唯一的调用，具体初始化方式在前面影院座位状态数据中已经提到。后续的座位状态更新在所有订单操作后通过唯一可更改`localStorage`的`saveCurrentCinemaState()`函数将更改过的`cinemaSeats`存入`localStorage`。

问题六：订单操作更改座位状态信息问题

- 问题描述：在某天merge后突然发现购买后如果点击刷新网页的话`canvas`中所有的座位都会还原为`available`状态，但订单信息都还在，查看`localStorage`发现其中的对应座位信息也都全部被刷新了。
- 原因分析：因为前面已经尽量控制过只有`saveCurrentCinemaState()`函数中对`localStorage`进行更改，其他函数只有调用这个函数才能引起`localStorage`变化。那么在刷新后就会被触发的函数只有时时刻刻都在检查的检查预定订单是否过期的`checkAndReleaseExpiredReservations()`函数，因为在网站初始化时还没有任何影院信息，canvas函数会先默认初始化一个10x20的空白影厅，此时的影厅所有座位均为可选择状态。而`checkAndReleaseExpiredReservations()`函数在检查后调用`saveCurrentCinemaState()`函数将更改过的`cinemaSeats`存入`localStorage`。但此时的`cinemaSeats`为默认空影厅，因此原本的影厅被覆盖了。
- 解决方法：从这个问题我们意识到存入`localStorage`的方式也存在漏洞，之前的`saveCurrentCinemaState()`传入的是当前`main.js`中存储的`cinemaSeats`需要在订单操作中加入影厅的具体信息，根据电影和对应影院的信息

问题七：（简称）（五粮液TODO：写3个）

* 问题描述：
* 原因分析：
* 解决方法：

问题十：（简称）（sigmalTODO：写3个）

* 问题描述：
* 原因分析：
* 解决方法：

## 五、总结与感悟

* 停云：（停云TODO：写100~200字）
* 六块：（六块TODO：写100~200字）
* 五粮液：（五粮液TODO：写100~200字）
* sigmal：（sigmalTODO：写100~200字）

## 六、分工

* 停云](https://github.com/tingyunaiai9)：（停云TODO）
* 六块](https://github.com/fujiimoku)：（六块TODO）
* 五粮液](https://github.com/wanly23)：（五粮液TODO）
* sigmal](https://github.com/sigmalyj)：（sigmalTODO）

## 参考资料

* 1] MDN Web Docs. Canvas API. https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API)
* 大模型：Gemini，Claude，ChatCPT
